<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sandoz ¬∑ LRV Manager Tool</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={theme:{extend:{fontFamily:{sans:['Inter','system-ui','Segoe UI','Roboto','Arial','sans-serif']}}}}</script>
<style>
:root{
  --primary:#0033A0; --primary-strong:#01256F; --accent:#18A0FB;
  --bg:#F6F8FB; --surface:#FFFFFF; --text:#0F172A; --mutetext:#475569; --border:#E2E8F0;
}
.btn{padding:8px 12px;border:1px solid #CBD5E1;border-radius:12px} .btn:hover{background:#F1F5F9}
.btn-primary{background:var(--primary);color:#fff;border-color:transparent}.btn-primary:hover{background:var(--primary-strong)}
.card{border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:0 1px 1px rgba(0,0,0,.02)}
.brand{width:32px;height:32px;border-radius:8px;background:var(--primary)}
.tabular-nums{font-variant-numeric:tabular-nums}
.chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid}
@media print{header,.no-print{display:none!important}.card{box-shadow:none}}
</style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)]">
<div id="app" class="min-h-screen"></div>

<script>
// ====== State ======
const S = {
  env: [{id:id(), name:'', weight:1}],
  resp: [{id:id(), name:'', weight:1}],
  notes:'', active:'diag', report:''
};
const $ = (sel, el=document)=> el.querySelector(sel);
const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));
function id(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function clamp(v,a,b){ v=Number(v)||0; return Math.max(a, Math.min(b, v)); }
function fix(n,d=2){ return Number.isFinite(n)? Number(n.toFixed(d)) : 0; }
function nonEmpty(x){ return (x.name||'').trim().length>0; }
function sumWeights(arr){ return arr.filter(nonEmpty).reduce((s,x)=> s + clamp(x.weight||1,1,5), 0); }
function save(){ localStorage.setItem('lrv_state', JSON.stringify(S)); }
function load(){ try{ Object.assign(S, JSON.parse(localStorage.getItem('lrv_state')||'{}')); }catch(e){} }

// ====== Templates ======
const TPL = {
  comex: {
    env:[
      ['–°–µ—Ç–∏: –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–∫–∏–¥–∫—É',3],
      ['–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ: –º–∞—Ä–∫–µ—Ç–∏–Ω–≥/–º–µ—Ä—á',2],
      ['E‚Äëcom: –¥–æ—Å—Ç–∞–≤–∫–∞/–∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç',2],
      ['–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç: —Å—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã',3],
      ['–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç: –¥–æ–ø. –ø—Ä–æ–º–æ‚Äë–º–µ—Å—Ç–∞',2],
      ['–û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞ —Å–ø—Ä–æ—Å–∞',3],
    ],
    resp:[
      ['–ü–æ—Ä–æ–≥–∏ –ø–æ–ª–Ω–æ–º–æ—á–∏–π –ø–æ —Å–∫–∏–¥–∫–∞–º (¬±X%)',3],
      ['–û—Ñ—Ñ–µ—Ä‚Äë–º–∞—Ç—Ä–∏—Ü–∞ (trade‚Äëoffs) + —à–∞–±–ª–æ–Ω—ã –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–π',3],
      ['–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π —Ç—Ä–∏–∞–∂ –∑–∞—è–≤–æ–∫ A/B/C –Ω–∞ ComEx',2],
      ['–®–∞–±–ª–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π',2],
      ['–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –æ–∫–Ω–∞ –ø—Ä–æ–º–æ –∏ –∫–≤–æ—Ç—ã –Ω–∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã',2],
    ]
  },
  kol: {
    env:[
      ['KOL: —Ü–µ–ª—å ‚Äî Education',2],
      ['KOL: —Ü–µ–ª—å ‚Äî Advisory',3],
      ['KOL: —Ü–µ–ª—å ‚Äî Collaboration',3],
      ['–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ: –±—Ä–µ–Ω–¥‚Äë–∑–∞–º–µ–Ω—ã/—Ü–µ–Ω–∞',2],
      ['–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–º–ø–ª–∞–µ–Ω—Å–∞/–º–∞—Ç–µ—Ä–∏–∞–ª—ã',2],
    ],
    resp:[
      ['–¢—Ä–∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ + –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≤—Ö–æ–¥–∞',3],
      ['SPV‚Äë—à–∞–±–ª–æ–Ω—ã –ø–æ–¥ –∫–∞–∂–¥—É—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é',3],
      ['–ò—Ç–æ–≥ –≤–∏–∑–∏—Ç–∞: –ö–û–ú–£? –ß–¢–û? –î–û –ö–û–ì–î–ê?',2],
      ['–ü—Ä–∞–≤–æ FLM –Ω–∞ –≤—ã–±–æ—Ä —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏/–º–∏–∫—Ä–æ‚Äë–æ—Ñ—Ñ–µ—Ä–∞',2],
    ]
  },
  acc: {
    env:[
      ['–°–µ–≥–º–µ–Ω—Ç: –û–†–õ',2],
      ['–°–µ–≥–º–µ–Ω—Ç: —Ç–µ—Ä–∞–ø–µ–≤—Ç',2],
      ['–°–µ–≥–º–µ–Ω—Ç: –ø–µ–¥–∏–∞—Ç—Ä',2],
      ['–ö–∞–Ω–∞–ª: —á–∞—Å—Ç–Ω–∞—è –∫–ª–∏–Ω–∏–∫–∞',2],
      ['–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ: —Ü–µ–Ω–∞/–∑–∞–º–µ–Ω—ã',3],
      ['–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ: –∫–æ–º–ø–ª–∞–µ–Ω—Å/–º–∞—Ç–µ—Ä–∏–∞–ª—ã',2],
      ['–§–æ—Ä–º–∞—Ç –≤–∏–∑–∏—Ç–∞: –∫–æ—Ä–æ—Ç–∫–∏–π/–ø–æ–ª–Ω—ã–π',1],
    ],
    resp:[
      ['SPV –ø–æ–¥ ACC 600 –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º',3],
      ['–ú–∏–Ω–∏‚Äëtrade –º–∞—Ç—Ä–∏—Ü–∞ (–¥–∞—ë–º/–ø–æ–ª—É—á–∞–µ–º)',2],
      ['–°–∫—Ä–∏–ø—Ç—ã –ø–æ–¥ 3 –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è',3],
      ['–ß–µ–∫‚Äë–ª–∏—Å—Ç: –ö–û–ú–£? –ß–¢–û? –î–û –ö–û–ì–î–ê?',2],
    ]
  }
};

// ====== App ======
function metric(){
  const env = S.env.filter(nonEmpty), resp = S.resp.filter(nonEmpty);
  const envCount = env.length, respCount = resp.length;
  const envW = sumWeights(env), respW = sumWeights(resp);
  const ratio = fix(envCount? respCount/envCount : 0);
  const ratioW = fix(envW? respW/envW : 0);
  const Henv = fix(envCount? Math.log2(envCount) : 0);
  const Hresp = fix(respCount? Math.log2(respCount) : 0);
  const Hgap = fix(Math.max(0, Henv - Hresp));
  const status = ratioW < 1 ? ['–ù–µ–¥–æ–±–æ—Ä (—É–∑–∫–æ–µ –≥–æ—Ä–ª—ã—à–∫–æ)','border-red-300 text-red-800 bg-red-100']
    : ratioW < 1.5 ? ['–ü—Ä–∏–µ–º–ª–µ–º–æ, –Ω–æ —É—è–∑–≤–∏–º–æ','border-amber-300 text-amber-800 bg-amber-100']
    : ['–ï—Å—Ç—å –∑–∞–ø–∞—Å –≥–∏–±–∫–æ—Å—Ç–∏','border-emerald-300 text-emerald-800 bg-emerald-100'];
  return {envCount, respCount, envW, respW, ratio, ratioW, Henv, Hresp, Hgap, status};
}

function render(){
  const root = document.getElementById('app');
  const m = metric();
  root.innerHTML = `
    <header class="sticky top-0 z-20 border-b" style="border-color:var(--border)">
      <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3 justify-between bg-white/90 backdrop-blur">
        <div class="flex items-center gap-3">
          <div class="brand"></div>
          <div class="leading-tight">
            <div class="font-semibold">Sandoz ¬∑ LRV Manager</div>
            <div class="text-xs text-slate-500">Law of Requisite Variety ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</div>
          </div>
        </div>
        <div class="flex items-center gap-2 no-print">
          <div class="relative">
            <button class="btn" id="tplBtn">üìÅ –®–∞–±–ª–æ–Ω—ã</button>
            <div id="tplMenu" class="hidden absolute right-0 mt-2 w-64 card p-2">
              <button class="w-full text-left btn" data-tpl="comex">ComEx</button>
              <button class="w-full text-left btn" data-tpl="kol">KOL</button>
              <button class="w-full text-left btn" data-tpl="acc">ACC 600 (–ê–ª–º–∞—Ç—ã)</button>
            </div>
          </div>
          <button class="btn" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <label class="btn cursor-pointer">–ò–º–ø–æ—Ä—Ç
            <input type="file" accept="application/json" class="hidden" id="importFile">
          </label>
          <button class="btn" id="printBtn">–ü–µ—á–∞—Ç—å</button>
        </div>
      </div>
    </header>

    <div class="mx-auto max-w-6xl px-4 pt-4">
      <div class="flex gap-2">
        ${['env','resp','diag','plan'].map(id=>`
          <button data-tab="${id}" class="px-3 py-2 rounded-xl border ${S.active===id?'bg-[var(--primary)] text-white border-transparent':'border-slate-300 hover:bg-slate-100'}">
            ${id==='env'?'1) –í—Ö–æ–¥—ã':id==='resp'?'2) –í–µ—Ç–≤–∏':id==='diag'?'3) –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞':'4) –ü–ª–∞–Ω'}
          </button>`).join('')}
      </div>
    </div>

    <main class="mx-auto max-w-6xl px-4 pb-8 grid md:grid-cols-2 gap-4">
      ${S.active==='env'?`
        <section class="card p-4 md:p-6">
          <h2 class="text-lg font-semibold mb-1">–®–∞–≥ 1. –í–Ω–µ—à–Ω–µ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ</h2>
          <p class="text-sm text-slate-600 mb-4">–¢–∏–ø—ã –∫–ª–∏–µ–Ω—Ç–æ–≤/–∫–∞–Ω–∞–ª–æ–≤, –≤–∏–¥—ã –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–ª—é—á–µ–≤—ã–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è. –û—Ü–µ–Ω–∏—Ç–µ –≤–∞–∂–Ω–æ—Å—Ç—å (1‚Äì5).</p>
          ${listEditor('env','–ù–∞–ø—Ä.: –°–µ—Ç–∏ ‚Äî –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–∫–∏–¥–∫—É')}
        </section>`:''}

      ${S.active==='resp'?`
        <section class="card p-4 md:p-6">
          <h2 class="text-lg font-semibold mb-1">–®–∞–≥ 2. –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ –≤–µ—Ç–≤–∏</h2>
          <p class="text-sm text-slate-600 mb-4">–ü–æ–ª–Ω–æ–º–æ—á–∏—è, SOP/–ø–ª–µ–π–±—É–∫–∏, –æ—Ñ—Ñ–µ—Ä‚Äë–º–∞—Ç—Ä–∏—Ü—ã, —à–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ò–°.</p>
          ${listEditor('resp','–ù–∞–ø—Ä.: –†–µ–≥–∏–æ–Ω ‚Äî –ø—Ä–∞–≤–æ —Å–∫–∏–¥–∫–∏ –¥–æ ¬±X%')}
        </section>`:''}

      ${S.active==='diag'?`
        <section class="card p-4 md:p-6 md:col-span-2">
          <h2 class="text-lg font-semibold mb-4">–®–∞–≥ 3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>
          <div class="grid md:grid-cols-4 gap-4">
            ${metricCard('–í—Ö–æ–¥–æ–≤ (—à—Ç)', m.envCount, '–í–µ—Å: '+m.envW)}
            ${metricCard('–í–µ—Ç–≤–µ–π (—à—Ç)', m.respCount, '–í–µ—Å: '+m.respW)}
            <div class="card p-4">
              <div class="text-sm font-medium text-slate-700">–ò–Ω–¥–µ–∫—Å—ã –ø–æ–∫—Ä—ã—Ç–∏—è</div>
              <div class="mt-2 flex flex-col gap-2">
                ${badgeLine('–ü—Ä–æ—Å—Ç–æ–π', m.ratio, m.status)}
                ${badgeLine('–í–∑–≤–µ—à–µ–Ω–Ω—ã–π', m.ratioW, m.status)}
              </div>
            </div>
            <div class="card p-4">
              <div class="text-sm font-medium text-slate-700">–°–ª–æ–∂–Ω–æ—Å—Ç—å (–±–∏—Ç—ã)</div>
              <div class="mt-2 text-sm">–°—Ä–µ–¥–∞: <b>${m.Henv}</b> ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <b>${m.Hresp}</b> ‚Ä¢ –†–∞–∑—Ä—ã–≤: <b>${m.Hgap}</b></div>
            </div>
          </div>

          <div class="mt-6 grid md:grid-cols-2 gap-4">
            <div class="card p-4">
              <h3 class="font-semibold mb-2">–£—Å–∏–ª–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
              <ul class="list-disc ml-5 text-sm space-y-1">
                ${['–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –ø–æ—Ä–æ–≥–∞–º (—Ä–µ–≥–∏–æ–Ω/ComEx/HQ)',
                   '–í–µ—Ç–≤—è—â–∏–µ—Å—è SOP/–ø–ª–µ–π–±—É–∫–∏ (if/then) –ø–æ–¥ 80 % –∫–µ–π—Å–æ–≤',
                   '–û—Ñ—Ñ–µ—Ä‚Äë–º–∞—Ç—Ä–∏—Ü—ã –∏ —à–∞–±–ª–æ–Ω—ã –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–π',
                   '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ –ò–° (–±–µ–∑ —Ä–µ–ª–∏–∑–∞)',
                   '–ö—Ä–æ—Å—Å‚Äë–æ–±—É—á–µ–Ω–∏–µ –∏ –≤–∑–∞–∏–º–æ–∑–∞–º–µ–Ω—è–µ–º–æ—Å—Ç—å —Ä–æ–ª–µ–π']
                   .map(s=>`<li class="${m.ratioW<1.5?'':'opacity-60'}">${s}</li>`).join('')}
              </ul>
            </div>
            <div class="card p-4">
              <h3 class="font-semibold mb-2">–û—Å–ª–∞–±–∏—Ç—å –≤—Ö–æ–¥</h3>
              <ul class="list-disc ml-5 text-sm space-y-1">
                ${['–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∫–∞–Ω–∞–ª–æ–≤/–∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Ä–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞',
                   '–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –≤—Ö–æ–¥–∞: —Ñ–æ—Ä–º—ã/–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è/¬´–≤–æ—Ä–æ—Ç–∞¬ª',
                   '–û–∫–Ω–∞/–∫–≤–æ—Ç—ã –Ω–∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã, —ç—Å–∫–∞–ª–∞—Ü–∏—è –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º',
                   '–†–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è SKU –∏ –∫–∞—Ç–∞–ª–æ–≥–æ–≤']
                   .map(s=>`<li class="${(m.ratioW<1 || m.envCount>20)?'':'opacity-60'}">${s}</li>`).join('')}
              </ul>
            </div>
          </div>

          <div class="mt-6">
            <label class="block text-sm font-medium text-slate-700 mb-2">–ó–∞–º–µ—Ç–∫–∏ / –∫–æ–Ω—Ç–µ–∫—Å—Ç</label>
            <textarea id="notes" rows="4" class="w-full rounded-xl border border-slate-300 p-3 focus:outline-none focus:ring-2 focus:ring-slate-400" placeholder="–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–º–ø–ª–∞–µ–Ω—Å–∞, —Å–µ–∑–æ–Ω—ã, KPI –∏ —Ç.–ø.">${escapeHtml(S.notes)}</textarea>
          </div>

          <div class="mt-4 flex flex-wrap gap-2 no-print">
            <button class="btn-primary btn" id="reportBtn">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
            <button class="btn" id="resetBtn">–°–±—Ä–æ—Å</button>
          </div>

          ${S.report?`
          <div class="mt-4">
            <label class="block text-sm font-medium text-slate-700 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞</label>
            <pre class="whitespace-pre-wrap card p-3 text-sm">${escapeHtml(S.report)}</pre>
          </div>`:''}
        </section>`:''}

      ${S.active==='plan'?`
        <section class="card p-4 md:p-6 md:col-span-2">
          <h2 class="text-lg font-semibold mb-2">–®–∞–≥ 4. –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (1‚Äì4 –Ω–µ–¥–µ–ª–∏)</h2>
          <ol class="list-decimal ml-5 text-sm space-y-1">
            <li>–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª–Ω–æ–º–æ—á–∏–π –∏ ¬´–∫—Ä–∞—Å–Ω—ã–µ –ª–∏–Ω–∏–∏¬ª.</li>
            <li>–°–æ–±—Ä–∞—Ç—å –≤–µ—Ç–≤—è—â–∏–π—Å—è SOP/–ø–ª–µ–π–±—É–∫ –ø–æ–¥ —Ç–æ–ø‚Äë80 % –∫–µ–π—Å–æ–≤.</li>
            <li>–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –≤—Ö–æ–¥–∞ (—Ñ–æ—Ä–º—ã/–≤–æ—Ä–æ—Ç–∞) –∏ –∫–≤–æ—Ç—ã.</li>
            <li>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å self‚Äëservice –¥–∞—à–±–æ—Ä–¥—ã/–ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑ —Ä–µ–ª–∏–∑–∞.</li>
            <li>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞ ComEx: —á—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å/—É—Ä–µ–∑–∞—Ç—å.</li>
          </ol>
        </section>`:''}
    </main>

    <footer class="mx-auto max-w-6xl px-4 py-6 text-xs text-slate-500">
      –ì–æ—Ç–æ–≤–æ –¥–ª—è GitHub Pages. –û–¥–∏–Ω —ç–∫—Ä–∞–Ω, —è–≤–Ω—ã–µ —à–∞–≥–∏, –ø–µ—á–∞—Ç—å/—ç–∫—Å–ø–æ—Ä—Ç. –û–±–Ω–æ–≤–ª—è–π—Ç–µ –≤–µ—Ç–≤–∏ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –≤—Ö–æ–¥–∞ –µ–∂–µ–º–µ—Å—è—á–Ω–æ.
    </footer>
  `;

  // Bind events
  $$('#app [data-tab]').forEach(b=> b.onclick = ()=> { S.active=b.dataset.tab; save(); render(); });
  $('#tplBtn')?.addEventListener('click', ()=> $('#tplMenu').classList.toggle('hidden'));
  $$('#tplMenu button').forEach(b=> b.onclick = ()=> loadTpl(b.dataset.tpl));
  $('#exportBtn')?.addEventListener('click', exportJSON);
  $('#importFile')?.addEventListener('change', (e)=> e.target.files[0] && importJSON(e.target.files[0]));
  $('#printBtn')?.addEventListener('click', ()=> window.print());
  $('#reportBtn')?.addEventListener('click', buildReport);
  $('#resetBtn')?.addEventListener('click', resetAll);
  $('#notes')?.addEventListener('input', (e)=> { S.notes = e.target.value; save(); });
}

function listEditor(kind, placeholder){
  const arr = S[kind];
  return `
    <div class="space-y-2">
      ${arr.map((x,i)=>`
      <div class="grid grid-cols-12 gap-2 items-center">
        <div class="col-span-9">
          <input data-${kind}="${x.id}" class="w-full rounded-xl border border-slate-300 p-2 focus:outline-none focus:ring-2 focus:ring-slate-400" placeholder="${i===0?placeholder:'–û–ø–∏—à–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç'}" value="${escapeAttr(x.name)}">
        </div>
        <div class="col-span-2">
          <label class="text-xs text-slate-500 block mb-1">–í–µ—Å (1‚Äì5)</label>
          <input type="number" min="1" max="5" data-${kind}-w="${x.id}" class="w-full rounded-xl border border-slate-300 p-2 focus:outline-none focus:ring-2 focus:ring-slate-400" value="${x.weight}">
        </div>
        <div class="col-span-1 flex justify-end">
          <button class="btn" data-${kind}-del="${x.id}" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
        </div>
      </div>`).join('')}
    </div>
    <div class="mt-3"><button class="btn" id="add-${kind}">–î–æ–±–∞–≤–∏—Ç—å</button></div>
  `;
}

function metricCard(title, value, sub){
  return `<div class="card p-4">
    <div class="text-sm font-medium text-slate-700">${title}</div>
    <div class="text-3xl font-semibold mt-1 tabular-nums">${value}</div>
    ${sub? `<div class="text-xs text-slate-500 mt-1">${sub}</div>`:''}
  </div>`;
}

function badgeLine(label, value, status){
  return `<div class="flex items-center justify-between gap-2">
    <div class="text-sm text-slate-700">${label}</div>
    <div class="flex items-center gap-2">
      <div class="text-lg font-semibold tabular-nums">${value}</div>
      <span class="chip ${status[1]}">${status[0]}</span>
    </div>
  </div>`;
}

function bindList(kind){
  // inputs
  $$(`#app [data-${kind}]`).forEach(inp=>{
    inp.oninput = ()=> { const x = S[kind].find(v=> v.id===inp.dataset[kind]); if(x){ x.name = inp.value; save(); } };
  });
  $$(`#app [data-${kind}-w]`).forEach(inp=>{
    inp.oninput = ()=> { const x = S[kind].find(v=> v.id===inp.dataset[kind+'W']); if(x){ x.weight = clamp(inp.value,1,5); save(); } };
  });
  $$(`#app [data-${kind}-del]`).forEach(btn=>{
    btn.onclick = ()=> { S[kind] = S[kind].filter(v=> v.id!==btn.dataset[kind+'Del']); save(); render(); };
  });
  // add
  const add = document.getElementById('add-'+kind);
  if(add) add.onclick = ()=> { S[kind].push({id:id(), name:'', weight:1}); save(); render(); };
}

function loadTpl(name){
  const t = TPL[name]; if(!t) return;
  S.env = t.env.map(([n,w])=> ({id:id(), name:n, weight:w}));
  S.resp = t.resp.map(([n,w])=> ({id:id(), name:n, weight:w}));
  S.active = 'diag'; save(); render();
}

function buildReport(){
  const m = metric();
  const envList = S.env.filter(nonEmpty).map((x,i)=> `${i+1}. ${x.name} [–≤–µ—Å ${clamp(x.weight,1,5)}]`).join('\n');
  const respList = S.resp.filter(nonEmpty).map((x,i)=> `${i+1}. ${x.name} [–≤–µ—Å ${clamp(x.weight,1,5)}]`).join('\n');
  const text = `–ó–ê–ö–û–ù –ù–ï–û–ë–•–û–î–ò–ú–û–ì–û –†–ê–ó–ù–û–û–ë–†–ê–ó–ò–Ø ‚Äî –û–¶–ï–ù–ö–ê
–î–∞—Ç–∞/–≤—Ä–µ–º—è: ${new Date().toLocaleString()}

–í–Ω–µ—à–Ω–µ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ: ${m.envCount} (–≤–µ—Å ${m.envW})
${envList}

–£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ –≤–µ—Ç–≤–∏: ${m.respCount} (–≤–µ—Å ${m.respW})
${respList}

–ò–Ω–¥–µ–∫—Å—ã –ø–æ–∫—Ä—ã—Ç–∏—è:
‚Äî –ü—Ä–æ—Å—Ç–æ–π: ${m.ratio}
‚Äî –í–∑–≤–µ—à–µ–Ω–Ω—ã–π: ${m.ratioW} (${m.status[0]})
‚Äî –°–ª–æ–∂–Ω–æ—Å—Ç—å (H): —Å—Ä–µ–¥–∞ ${m.Henv} –±–∏—Ç–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ${m.Hresp} –±–∏—Ç–∞, —Ä–∞–∑—Ä—ã–≤ ${m.Hgap} –±–∏—Ç–∞

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
${m.ratioW<1.5? '‚Ä¢ –£—Å–∏–ª–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, SOP/–ø–ª–µ–π–±—É–∫–∏, –æ—Ñ—Ñ–µ—Ä‚Äë–º–∞—Ç—Ä–∏—Ü—ã, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ò–°.' : '‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–æ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –≤ –Ω–æ—Ä–º–µ: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –µ–∂–µ–º–µ—Å—è—á–Ω—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.'}
${(m.ratioW<1 || m.envCount>20)? '‚Ä¢ –û—Å–ª–∞–±–∏—Ç—å –≤–Ω–µ—à–Ω–µ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ: —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è, —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –≤—Ö–æ–¥–∞, –æ–∫–Ω–∞/–∫–≤–æ—Ç—ã, —Ä–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è SKU.' : '‚Ä¢ –í–Ω–µ—à–Ω–µ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º: –¥–µ—Ä–∂–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –≤—Ö–æ–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏.'}

–ó–∞–º–µ—Ç–∫–∏:
${S.notes||'‚Äî'}`;
  S.report = text; save(); render();
  navigator.clipboard.writeText(text).catch(()=>{});
}

function exportJSON(){
  const m = metric();
  const data = { generatedAt: new Date().toISOString(), envItems: S.env.filter(nonEmpty), respItems: S.resp.filter(nonEmpty), notes: S.notes, metrics: m };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'lrv-assessment.json'; a.click(); URL.revokeObjectURL(url);
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const data = JSON.parse(e.target.result);
      S.env = (data.envItems||[]).map(x=> ({id:id(), name:x.name, weight: clamp(x.weight,1,5)}));
      S.resp = (data.respItems||[]).map(x=> ({id:id(), name:x.name, weight: clamp(x.weight,1,5)}));
      S.notes = data.notes||''; S.active='diag'; save(); render();
    }catch(err){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON'); }
  };
  reader.readAsText(file);
}

function resetAll(){
  S.env=[{id:id(), name:'', weight:1}]; S.resp=[{id:id(), name:'', weight:1}]; S.notes=''; S.report=''; save(); render();
}

// Helpers
function escapeHtml(s){ return (s||'').replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

// Boot
load();
render();
bindList('env'); bindList('resp');

function bindList(kind){ // initial bind (since render runs once here)
  document.addEventListener('input', (e)=>{
    const t=e.target;
    if(t.matches(`[data-${kind}]`)){ const x=S[kind].find(v=> v.id===t.dataset[kind]); if(x){ x.name=t.value; save(); } }
    if(t.matches(`[data-${kind}-w]`)){ const x=S[kind].find(v=> v.id===t.dataset[kind+'W']); if(x){ x.weight=clamp(t.value,1,5); save(); } }
  });
  document.addEventListener('click', (e)=>{
    const t=e.target;
    if(t.matches(`[data-${kind}-del]`)){ S[kind]=S[kind].filter(v=> v.id!==t.dataset[kind+'Del']); save(); render(); }
    if(t.id==='add-'+kind){ S[kind].push({id:id(), name:'', weight:1}); save(); render(); }
    if(t.id==='tplBtn'){ $('#tplMenu')?.classList.toggle('hidden'); }
    if(t.closest('#tplMenu') && t.dataset.tpl){ loadTpl(t.dataset.tpl); }
    if(t.id==='exportBtn') exportJSON();
    if(t.id==='printBtn') window.print();
    if(t.id==='reportBtn') buildReport();
    if(t.id==='resetBtn') resetAll();
    if(t.id==='importFile'){} // handled by change
  });
  $('#importFile')?.addEventListener('change',(e)=> e.target.files[0] && importJSON(e.target.files[0]));
}
</script>
</body>
</html>
