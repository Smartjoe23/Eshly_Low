export default function LRVManagerTool() {
  /**
   * Закон необходимого разнообразия (Эшби) — прикладной инструмент
   * Евгений, это одностраничный инструмент для руководителей:
   * 1) Опиши внешнее разнообразие (входы/кейсы) -> список.
   * 2) Опиши управленческие ответы (ветви решений/SOP/полномочия) -> список.
   * 3) Получи индексы покрытия, статус и рекомендации (усилить управление / ослабить внешнее разнообразие).
   * Встроены шаблоны для ComEx, KOL и ACC 600 (Алматы). Можно печатать и экспортировать JSON/отчёт.
   */

  // ------------ React state ------------
  const [envItems, setEnvItems] = React.useState([
    { id: 1, name: "", weight: 1 },
  ]);
  const [respItems, setRespItems] = React.useState([
    { id: 1, name: "", weight: 1 },
  ]);
  const [notes, setNotes] = React.useState("");
  const [showHelp, setShowHelp] = React.useState(false);
  const [report, setReport] = React.useState("");

  // ------------ Helpers ------------
  const clamp = (v, min, max) => Math.max(min, Math.min(max, Number(v) || 0));
  const nonEmpty = (x) => (x.name || "").trim().length > 0;
  const sumWeights = (arr) => arr.filter(nonEmpty).reduce((s, x) => s + clamp(x.weight || 1, 1, 5), 0);
  const countItems = (arr) => arr.filter(nonEmpty).length;

  // Metrics
  const envCount = countItems(envItems);
  const respCount = countItems(respItems);
  const envW = sumWeights(envItems);
  const respW = sumWeights(respItems);

  const ratioSimple = envCount === 0 ? 0 : +(respCount / envCount).toFixed(2);
  const ratioWeighted = envW === 0 ? 0 : +(respW / envW).toFixed(2);

  // Status evaluation
  function evalStatus(r) {
    if (r < 1) return { label: "Недобор (узкое горлышко)", color: "bg-red-100 text-red-800 border-red-300" };
    if (r < 1.5) return { label: "Приемлемо, но уязвимо", color: "bg-amber-100 text-amber-800 border-amber-300" };
    return { label: "Есть запас гибкости", color: "bg-emerald-100 text-emerald-800 border-emerald-300" };
  }
  const simpleStatus = evalStatus(ratioSimple);
  const weightedStatus = evalStatus(ratioWeighted);

  // Actions suggestions based on deficit/excess
  const needStrengthen = ratioWeighted < 1.5; // чуть консервативнее
  const needFilter = ratioWeighted < 1 || envCount > 20; // когда вход "шумит" или явный недобор

  // ------------ CRUD for lists ------------
  function addEnv() {
    setEnvItems((xs) => [...xs, { id: Date.now() + Math.random(), name: "", weight: 1 }]);
  }
  function addResp() {
    setRespItems((xs) => [...xs, { id: Date.now() + Math.random(), name: "", weight: 1 }]);
  }
  function updEnv(id, field, value) {
    setEnvItems((xs) => xs.map((x) => (x.id === id ? { ...x, [field]: field === "weight" ? clamp(value, 1, 5) : value } : x)));
  }
  function updResp(id, field, value) {
    setRespItems((xs) => xs.map((x) => (x.id === id ? { ...x, [field]: field === "weight" ? clamp(value, 1, 5) : value } : x)));
  }
  function delEnv(id) {
    setEnvItems((xs) => xs.filter((x) => x.id !== id));
  }
  function delResp(id) {
    setRespItems((xs) => xs.filter((x) => x.id !== id));
  }
  function resetAll() {
    setEnvItems([{ id: 1, name: "", weight: 1 }]);
    setRespItems([{ id: 1, name: "", weight: 1 }]);
    setNotes("");
    setReport("");
  }

  // ------------ Templates ------------
  function loadTemplate(name) {
    if (name === "comex") {
      setEnvItems([
        { id: 1, name: "Канал: сети аптек — запросы на скидку", weight: 3 },
        { id: 2, name: "Канал: независимые аптеки — маркетинговые активности", weight: 2 },
        { id: 3, name: "Канал: e-com — условия доставки/ассортимента", weight: 2 },
        { id: 4, name: "Нестандарты: сроки оплаты", weight: 3 },
        { id: 5, name: "Нестандарты: дополнительные промо-места", weight: 2 },
        { id: 6, name: "Отклонения прогноза спроса", weight: 3 },
      ]);
      setRespItems([
        { id: 7, name: "Границы полномочий регионов по скидкам (±X%)", weight: 3 },
        { id: 8, name: "Оффер-матрица (trade-offs) + шаблоны обоснования", weight: 3 },
        { id: 9, name: "Триаж заявок A/B/C на еженедельном ComEx", weight: 2 },
        { id: 10, name: "Шаблоны договоров/приложений", weight: 2 },
        { id: 11, name: "Календарные окна промо и квоты на нестандарты", weight: 2 },
      ]);
      setNotes("Шаблон ComEx загружен: настрой границы, офферы и триаж под ваш рынок.");
    }
    if (name === "kol") {
      setEnvItems([
        { id: 1, name: "Встреча с KOL: цель — образование пациентов/коллег", weight: 2 },
        { id: 2, name: "Встреча с KOL: цель — экспертная консультация (advisory)", weight: 3 },
        { id: 3, name: "Встреча с KOL: цель — совместный проект/пилот", weight: 3 },
        { id: 4, name: "Возражения: бренд-замены/цена", weight: 2 },
        { id: 5, name: "Ограничения комплаенса/формат материалов", weight: 2 },
      ]);
      setRespItems([
        { id: 6, name: "Три траектории: Education / Advisory / Collaboration", weight: 3 },
        { id: 7, name: "SPV-шаблоны под каждую траекторию", weight: 3 },
        { id: 8, name: "Чек-лист итогов визита: КОМУ? ЧТО? ДО КОГДА?", weight: 2 },
        { id: 9, name: "Право FLM выбирать траекторию и микро-оффер", weight: 2 },
      ]);
      setNotes("Шаблон KOL загружен: уточни материалы и критерии готовности.");
    }
    if (name === "acc") {
      setEnvItems([
        { id: 1, name: "Сегмент врача: оториноларинголог", weight: 2 },
        { id: 2, name: "Сегмент врача: терапевт", weight: 2 },
        { id: 3, name: "Сегмент врача: педиатр", weight: 2 },
        { id: 4, name: "Канал: частная клиника", weight: 2 },
        { id: 5, name: "Возражение: цена/бренд-замены", weight: 3 },
        { id: 6, name: "Возражение: комплаенс/материалы", weight: 2 },
        { id: 7, name: "Формат визита: короткий/полный", weight: 1 },
      ]);
      setRespItems([
        { id: 8, name: "SPV под ACC 600 для каждого сегмента", weight: 3 },
        { id: 9, name: "Мини-trade матрица (что даём/что получаем)", weight: 2 },
        { id: 10, name: "Ветвящийся скрипт под 3 ключевых возражения", weight: 3 },
        { id: 11, name: "Чек-лист фиксации: КОМУ? ЧТО? ДО КОГДА?", weight: 2 },
      ]);
      setNotes("Шаблон ACC 600 загружен: адаптируй под Алмату/регион.");
    }
  }

  // ------------ Report & Export ------------
  function buildReport() {
    const time = new Date().toLocaleString();
    const envList = envItems.filter(nonEmpty).map((x, i) => `${i + 1}. ${x.name} [вес ${clamp(x.weight, 1, 5)}]`).join("\n");
    const respList = respItems.filter(nonEmpty).map((x, i) => `${i + 1}. ${x.name} [вес ${clamp(x.weight, 1, 5)}]`).join("\n");
    const text = `ЗАКОН НЕОБХОДИМОГО РАЗНООБРАЗИЯ — ОЦЕНКА\nДата/время: ${time}\n\nВнешнее разнообразие (входы): ${envCount} позиций, суммарный вес ${envW}\n${envList}\n\nУправленческие ответы (ветви): ${respCount} позиций, суммарный вес ${respW}\n${respList}\n\nИндексы покрытия:\n— Простой: ${ratioSimple} (${simpleStatus.label})\n— Взвешенный: ${ratioWeighted} (${weightedStatus.label})\n\nРекомендации:\n${needStrengthen ? "• Усилить управленческое разнообразие: делегирование, ветвящиеся SOP/плейбуки, оффер-матрицы, конфигурируемые правила в ИС." : "• Управленческое разнообразие в норме: поддерживайте ежемесячную калибровку ветвей/полномочий."}\n${needFilter ? "• Ослабить внешнее разнообразие: сегментация, стандартизированные формы/ворота, окна/квоты, рационализация SKU." : "• Внешнее разнообразие под контролем: держите стандарты входа и каталоги в актуальном состоянии."}\n\nЗаметки:\n${notes || "—"}`;
    setReport(text);
  }

  function copyReport() {
    if (!report) buildReport();
    setTimeout(() => {
      navigator.clipboard.writeText(report || "");
      alert("Отчёт скопирован в буфер обмена");
    }, 50);
  }

  function exportJSON() {
    const data = {
      generatedAt: new Date().toISOString(),
      envItems: envItems.filter(nonEmpty),
      respItems: respItems.filter(nonEmpty),
      metrics: { envCount, respCount, envW, respW, ratioSimple, ratioWeighted },
      notes,
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "lrv-assessment.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function printPage() {
    window.print();
  }

  // ------------ UI -------------
  return (
    <div className="min-h-screen bg-slate-50 text-slate-900">
      <header className="sticky top-0 z-10 border-b border-slate-200 bg-white/90 backdrop-blur">
        <div className="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
          <h1 className="text-xl md:text-2xl font-semibold tracking-tight">Закон необходимого разнообразия — инструмент руководителя</h1>
          <div className="flex gap-2">
            <button onClick={() => setShowHelp((v) => !v)} className="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Справка</button>
            <button onClick={printPage} className="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Печать</button>
          </div>
        </div>
      </header>

      {showHelp && (
        <section className="mx-auto max-w-6xl px-4 py-4">
          <div className="rounded-2xl border border-slate-200 bg-white p-4 md:p-6 shadow-sm">
            <h2 className="text-lg font-semibold mb-2">Как пользоваться</h2>
            <ol className="list-decimal ml-5 space-y-1 text-sm md:text-base">
              <li>В блоке <b>«Шаг 1»</b> перечислите разные типы входов/кейсов (сегменты клиентов, типы запросов, ключевые возражения и т.п.). При желании оцените важность (вес 1–5).</li>
              <li>В блоке <b>«Шаг 2»</b> перечислите реальные управленческие ветви (SOP/политики, полномочия, шаблоны офферов, скрипты, конфигурируемые правила).</li>
              <li>В <b>«Шаг 3»</b> посмотрите индексы покрытия. Если индекс ниже 1 — недобор, 1–1.5 — уязвимо, выше 1.5 — запас.</li>
              <li>Снизу появятся рекомендации: где <i>усилить управление</i>, а где <i>ослабить внешнее разнообразие</i> (сегментация, стандарты входа, окна/квоты).</li>
              <li>Добавьте свои заметки, сформируйте отчёт, скачайте JSON или отправьте отчёт (копировать в буфер).</li>
            </ol>
            <div className="mt-3 text-xs text-slate-600">Памятка: «Только разнообразие в управлении уменьшает разнообразие исходов». Балансируйте два рычага: наращивайте ветви решений и/или фильтруйте вход.</div>
          </div>
        </section>
      )}

      <main className="mx-auto max-w-6xl px-4 py-6 grid md:grid-cols-2 gap-4 md:gap-6">
        {/* Шаг 1 */}
        <section className="rounded-2xl border border-slate-200 bg-white p-4 md:p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-1">Шаг 1. Внешнее разнообразие (входы)</h2>
          <p className="text-sm text-slate-600 mb-4">Примеры: типы клиентов/каналов, виды запросов, ключевые возражения, ограничения комплаенса и т.д.</p>
          <ListEditor
            items={envItems}
            onAdd={addEnv}
            onChange={updEnv}
            onDelete={delEnv}
            placeholder="Например: Сеть аптек — запрос на скидку"
          />
        </section>

        {/* Шаг 2 */}
        <section className="rounded-2xl border border-slate-200 bg-white p-4 md:p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-1">Шаг 2. Управленческие ответы (ветви решений)</h2>
          <p className="text-sm text-slate-600 mb-4">Примеры: полномочия, ветвящиеся SOP/плейбуки, оффер-матрицы, шаблоны ответов, конфигурируемые правила ИС.</p>
          <ListEditor
            items={respItems}
            onAdd={addResp}
            onChange={updResp}
            onDelete={delResp}
            placeholder="Например: Региональное право скидки до ±X%"
          />
        </section>

        {/* Шаг 3 */}
        <section className="md:col-span-2 rounded-2xl border border-slate-200 bg-white p-4 md:p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-4">Шаг 3. Результаты и рекомендации</h2>
          <div className="grid md:grid-cols-3 gap-4">
            <MetricCard title="Входов (шт)" value={envCount} sub={`Суммарный вес: ${envW}`} />
            <MetricCard title="Ветвей (шт)" value={respCount} sub={`Суммарный вес: ${respW}`} />
            <div className="rounded-2xl border border-slate-200 p-4">
              <div className="text-sm font-medium text-slate-700">Индексы покрытия</div>
              <div className="mt-2 flex flex-col gap-2">
                <BadgeLine label="Простой" value={ratioSimple} status={simpleStatus} />
                <BadgeLine label="Взвешенный" value={ratioWeighted} status={weightedStatus} />
              </div>
            </div>
          </div>

          <div className="mt-6 grid md:grid-cols-2 gap-4">
            <div className="rounded-2xl border border-slate-200 p-4">
              <h3 className="font-semibold mb-2">Усилить управленческое разнообразие</h3>
              <ul className="text-sm list-disc ml-5 space-y-1">
                <li className={needStrengthen ? "" : "opacity-60"}>Делегирование по порогам решений (регион/ComEx/HQ)</li>
                <li className={needStrengthen ? "" : "opacity-60"}>Ветвящиеся SOP/плейбуки (если/то) под 80 % кейсов</li>
                <li className={needStrengthen ? "" : "opacity-60"}>Оффер-матрицы и шаблоны обоснований (trade-offs)</li>
                <li className={needStrengthen ? "" : "opacity-60"}>Конфигурируемые правила в ИС (без релиза)</li>
                <li className={needStrengthen ? "" : "opacity-60"}>Кросс-обучение и взаимозаменяемость ролей</li>
              </ul>
            </div>
            <div className="rounded-2xl border border-slate-200 p-4">
              <h3 className="font-semibold mb-2">Ослабить внешнее разнообразие</h3>
              <ul className="text-sm list-disc ml-5 space-y-1">
                <li className={needFilter ? "" : "opacity-60"}>Сегментация каналов/клиентов и разные правила</li>
                <li className={needFilter ? "" : "opacity-60"}>Стандарты входа: формы, обязательные поля, «ворота»</li>
                <li className={needFilter ? "" : "opacity-60"}>Окна/квоты на нестандарты и «красная кнопка»</li>
                <li className={needFilter ? "" : "opacity-60"}>Рационализация SKU и каталогов</li>
              </ul>
            </div>
          </div>

          <div className="mt-6">
            <label className="block text-sm font-medium text-slate-700 mb-2">Заметки / контекст</label>
            <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={4} className="w-full rounded-xl border border-slate-300 p-3 focus:outline-none focus:ring-2 focus:ring-slate-400" placeholder="Добавьте важные нюансы: ограничения комплаенса, сезоны, KPI и т.п." />
          </div>

          <div className="mt-4 flex flex-wrap gap-2">
            <button onClick={buildReport} className="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">Сформировать отчёт</button>
            <button onClick={copyReport} className="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Копировать отчёт</button>
            <button onClick={exportJSON} className="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Экспорт JSON</button>
            <button onClick={resetAll} className="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Сброс</button>
          </div>

          {report && (
            <div className="mt-4">
              <label className="block text-sm font-medium text-slate-700 mb-2">Предпросмотр отчёта</label>
              <pre className="whitespace-pre-wrap rounded-xl border border-slate-200 bg-slate-50 p-3 text-sm">{report}</pre>
            </div>
          )}
        </section>

        {/* Шаблоны */}
        <section className="md:col-span-2 rounded-2xl border border-slate-200 bg-white p-4 md:p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-3">Готовые шаблоны</h2>
          <div className="flex flex-wrap gap-2">
            <button onClick={() => loadTemplate("comex")} className="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">ComEx</button>
            <button onClick={() => loadTemplate("kol")} className="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">KOL</button>
            <button onClick={() => loadTemplate("acc")} className="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">ACC 600 (Алматы)</button>
          </div>
          <p className="text-xs text-slate-600 mt-2">Шаблоны загружают примеры для быстрого старта. Отредактируйте под ваш контекст.</p>
        </section>

        {/* Теория кратко */}
        <section className="md:col-span-2 rounded-2xl border border-slate-200 bg-white p-4 md:p-6 shadow-sm print:break-before-page">
          <h2 className="text-lg font-semibold mb-2">Краткая теория для команды</h2>
          <div className="text-sm text-slate-700 space-y-2">
            <p><b>Закон необходимого разнообразия (Эшби):</b> управлять исходами возможно только если разнообразие управленческих ответов не меньше разнообразия входов среды.</p>
            <p><b>Практический вывод:</b> либо увеличиваем число «ветвей» (делегирование, SOP, офферы, гибкая ИС), либо уменьшаем «шум» входа (сегментация, стандарты, окна/квоты), чаще — и то, и другое.</p>
            <p><b>Правило одного экрана:</b> если центр не «тянет» решения в разумные сроки — переносим часть решений вниз по иерархии и чётко задаём границы.</p>
          </div>
        </section>
      </main>

      <footer className="mx-auto max-w-6xl px-4 py-6 text-xs text-slate-500">
        Сделано как «дуракаустойчивый» инструмент: один экран, явные шаги, печать/экспорт. Обновляйте ветви и стандарты входа ежемесячно.
      </footer>
    </div>
  );
}

// ------------- Components -------------
function ListEditor({ items, onAdd, onChange, onDelete, placeholder }) {
  return (
    <div>
      <div className="space-y-2">
        {items.map((x, idx) => (
          <div key={x.id} className="grid grid-cols-12 gap-2 items-center">
            <div className="col-span-9">
              <input
                value={x.name}
                onChange={(e) => onChange(x.id, "name", e.target.value)}
                className="w-full rounded-xl border border-slate-300 p-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                placeholder={idx === 0 ? placeholder : "Опишите элемент"}
              />
            </div>
            <div className="col-span-2">
              <label className="text-xs text-slate-500 block mb-1">Вес (1–5)</label>
              <input
                type="number"
                min={1}
                max={5}
                value={x.weight}
                onChange={(e) => onChange(x.id, "weight", e.target.value)}
                className="w-full rounded-xl border border-slate-300 p-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
              />
            </div>
            <div className="col-span-1 flex justify-end">
              <button onClick={() => onDelete(x.id)} title="Удалить" className="h-10 w-10 rounded-xl border border-slate-300 hover:bg-slate-100">×</button>
            </div>
          </div>
        ))}
      </div>
      <div className="mt-3">
        <button onClick={onAdd} className="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Добавить</button>
      </div>
    </div>
  );
}

function MetricCard({ title, value, sub }) {
  return (
    <div className="rounded-2xl border border-slate-200 p-4">
      <div className="text-sm font-medium text-slate-700">{title}</div>
      <div className="text-3xl font-semibold mt-1">{value}</div>
      {sub && <div className="text-xs text-slate-500 mt-1">{sub}</div>}
    </div>
  );
}

function BadgeLine({ label, value, status }) {
  return (
    <div className="flex items-center justify-between gap-2">
      <div className="text-sm text-slate-700">{label}</div>
      <div className="flex items-center gap-2">
        <div className="text-lg font-semibold tabular-nums">{value}</div>
        <span className={`text-xs px-2 py-1 rounded-full border ${status.color}`}>{status.label}</span>
      </div>
    </div>
  );
}
